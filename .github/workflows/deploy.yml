# ──────────────────────────────────────────────────────────────────
# Leezr — Build & Deploy (ADR-076)
#
# Build in CI (no pnpm on VPS), atomic release, rollback-ready.
# Trigger: push to main (production) or dev (staging).
# ──────────────────────────────────────────────────────────────────

name: Build & Deploy

on:
  push:
    branches: [main, dev]

# One deploy per branch at a time — queue, don't cancel
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: false

env:
  PHP_VERSION: "8.3"
  NODE_VERSION: "22"

jobs:
  # ════════════════════════════════════════════════════════════════
  # BUILD — runs on GitHub Actions runner, produces a release artifact
  # ════════════════════════════════════════════════════════════════
  build:
    name: Build artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, pdo_mysql, bcmath
          tools: composer:v2

      - name: Composer install (production)
        run: composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: pnpm install
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        env:
          VITE_APP_VERSION: ${{ github.sha }}
        run: pnpm build

      - name: Write build metadata
        run: |
          echo "${{ github.sha }}" > .build-sha
          git rev-parse --short HEAD > .build-version

      - name: Create release artifact
        run: |
          tar czf /tmp/release.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='storage' \
            --exclude='.env' \
            --exclude='tests' \
            --exclude='.github' \
            --exclude='resources/ui' \
            --exclude='resources/js' \
            --exclude='resources/styles' \
            --exclude='docs' \
            --exclude='compose.yaml' \
            --exclude='phpunit.xml' \
            --exclude='vite.config.*' \
            --exclude='pnpm-lock.yaml' \
            --exclude='package.json' \
            --exclude='*.d.ts' \
            --exclude='.eslintrc*' \
            --exclude='scripts' \
            .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}-${{ github.sha }}
          path: /tmp/release.tar.gz
          retention-days: 7

  # ════════════════════════════════════════════════════════════════
  # DEPLOY — SSH to VPS, unpack artifact, atomic symlink switch
  # ════════════════════════════════════════════════════════════════
  deploy:
    name: Deploy to ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}
    steps:
      - name: Checkout deploy scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: deploy/

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: release-${{ github.ref_name }}-${{ github.sha }}
          path: /tmp

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ vars.VPS_PORT || 22 }} ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Upload artifact to VPS
        run: |
          scp -i ~/.ssh/deploy_key \
            -P ${{ vars.VPS_PORT || 22 }} \
            /tmp/release.tar.gz \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/leezr-release-${{ github.ref_name }}.tar.gz

      - name: Upload deploy script
        run: |
          scp -i ~/.ssh/deploy_key \
            -P ${{ vars.VPS_PORT || 22 }} \
            deploy/deploy_release.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/tmp/leezr-deploy.sh

      - name: Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -p ${{ vars.VPS_PORT || 22 }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "bash /tmp/leezr-deploy.sh /tmp/leezr-release-${{ github.ref_name }}.tar.gz ${{ vars.APP_PATH }}"

      - name: Health check
        run: |
          DEPLOY_URL="${{ vars.DEPLOY_URL }}"
          echo "Checking $DEPLOY_URL/up ..."
          for i in 1 2 3 4 5; do
            STATUS=$(curl -sk -o /dev/null -w "%{http_code}" "$DEPLOY_URL/up" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed: $DEPLOY_URL/up → 200"
              exit 0
            fi
            echo "  Attempt $i/5: $DEPLOY_URL/up → $STATUS (retrying in 5s...)"
            sleep 5
          done
          echo "HEALTH CHECK FAILED after 5 attempts"
          echo "Fetching last 50 lines of deploy.log..."
          ssh -i ~/.ssh/deploy_key \
            -p ${{ vars.VPS_PORT || 22 }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "tail -50 ${{ vars.APP_PATH }}/shared/storage/logs/deploy.log 2>/dev/null || echo 'No deploy.log found'"
          exit 1

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Cleanup remote artifact
        if: always()
        run: |
          ssh -i ~/.ssh/deploy_key \
            -p ${{ vars.VPS_PORT || 22 }} \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "rm -f /tmp/leezr-release-${{ github.ref_name }}.tar.gz /tmp/leezr-deploy.sh" 2>/dev/null || true
